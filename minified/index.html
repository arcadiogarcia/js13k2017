<style media="screen" type="text/css">
    body {
        text-align: center;
        margin: 0px;
        background-color: black;
    }

    canvas,
    img {
        image-rendering: optimizeSpeed;
        image-rendering: -moz-crisp-edges;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: optimize-contrast;
        image-rendering: pixelated;
        -ms-interpolation-mode: nearest-neighbor;
    }

    canvas {
        width: 100%;
        height: 100%;
    }
</style>

<body>
    <canvas id=a>
        <script>
            imgs={},Promise.all(["a","b","c","c2","h","k","m"].map(b=>{return imgs[b]=new Image,imgs[b].src=b+".png",new Promise(function(c){imgs[b].onload=c})})).then(start),x=a.getContext`2d`,colors=["red","blue","green","yellow","lime","aqua","orange","fuchsia"],bombs=["https://www.youtube.com/watch?v=dQw4w9WgXcQ","http://christmaschebacca.ytmnd.com/","https://www.badgerbadgerbadger.com/","http://fakebsod.com/generic","http://dn.ht/picklecat/","http://mischiefmakersmanual.com/tools/annoy/homepage.html"],m=!1;function start(){if(""==window.location.hash){if(a.width=x.width=window.innerWidth,a.height=x.height=window.innerHeight,localStorage.p="[]",localStorage.g="[]",p=[],!navigator.serviceWorker)return x.fillStyle="black",x.fillRect(0,0,a.width,a.height),x.fillStyle="white",x.font="30px Sans-serif",x.textAlign="center",x.fillText("Service Worker not supported",a.width/2,200),x.font="25px Sans-serif",void x.fillText("Upgrade your browser to play the game",a.width/2,250);navigator.serviceWorker.register("w.js").then(function(){updater(),onclick=()=>{onclick=()=>{},updated(),navigator.serviceWorker.controller.postMessage("s"),startSound()}}).catch(function(c){console.log("Service worker registration failed:",c)}),x.fillStyle="black",x.fillRect(0,0,a.width,a.height),x.fillStyle="white",x.font="60px Sans-serif",x.textAlign="center",x.fillText("Lost Tab",a.width/2,200),x.font="30px Sans-serif",x.fillText("The Evil Autoplaying Video Strikes Again",a.width/2,250),x.font="40px Sans-serif",x.fillText("Click to start",a.width/2,600),x.font="20px Sans-serif",x.fillText("Please make sure to allow pop-ups",a.width/2,650),document.title="Lost Tab",updated=function(){g=JSON.parse(localStorage.g),p=JSON.parse(localStorage.p),x.fillStyle="black",x.fillRect(0,0,a.width,a.height),x.fillStyle="white",x.font="30px Sans-serif",x.fillText("Inventory:",100,100),document.title="Inventory",p.forEach(function(c,d){x.fillStyle=colors[c[1]]||"white",x.fillRect(20+120*(d%4),220+120*Math.floor(d/4),100,100),x.drawImage(imgs[c[0]],0,0,16,16,20+120*(d%4),220+120*Math.floor(d/4),100,100)})}}else{function c(d,f){x.fillStyle="black",x.fillRect(0,0,40,40),x.fillStyle=d,x.fillRect(12,12,16,16),x.drawImage(f,12,12)}var b=window.innerHeight>window.innerWidth?window.innerWidth:window.innerHeight;a.style.height=a.style.width=b,a.width=x.width=40,a.height=x.height=40,updated=function(){g=JSON.parse(localStorage.g),p=JSON.parse(localStorage.p),s=g[parseInt(window.location.hash.substring(1))],document.title=m?s.map(d=>{return{a:"Autoplaying media",b:"Bomb",c:"Crate",h:"Keyhole #"+d.substring(1),k:"Key #"+d.substring(1),m:"Map"}[d[0]]}).reduce((d,f)=>f+"->"+d):"???",c(colors[s[s.length-1].substring(1)]||"white",imgs[s[s.length-1][0]])},updated(),onclick=()=>{switch(s[s.length-1][0]){case"a":break;case"c":t=0,it=setInterval(()=>{c("white",imgs.c2),x.globalAlpha=t/8,x.fillStyle="black",x.fillRect(0,0,a.width,a.height),x.globalAlpha=1,t++},50),s.pop(),setTimeout(()=>{save(),clearInterval(it)},500);break;case"h":j=p.indexOf("k"+s[s.length-1].substring(1)),-1!=j&&(s.pop(),p.splice(j,1),save());break;case"k":p.push(s.pop()),save();break;case"m":navigator.serviceWorker.controller.postMessage("m"),close();}onfocus()},updater(),window.onfocus=function(){"b"==s[s.length-1]&&"l"==localStorage.l&&(setTimeout(()=>{c("yellow",imgs.b)},300),setTimeout(()=>{c("red",imgs.b)},600),setTimeout(()=>{window.open(bombs[Math.floor(bombs.length*Math.random())],"_blank"),close()},900)),"a"==s[s.length-1]&&"l"==localStorage.l&&setTimeout(()=>{navigator.serviceWorker.controller.postMessage("w")},900)}}}function save(){g[parseInt(window.location.hash.substring(1))]=s,localStorage.g=JSON.stringify(g),localStorage.p=JSON.stringify(p),navigator.serviceWorker.controller.postMessage("u")}function updater(){navigator.serviceWorker.addEventListener("message",b=>{switch(b.data.k){case"l":g=b.data.a,localStorage.g=JSON.stringify(g),localStorage.l="",b.data.a.forEach((c,d)=>window.open(location+"#"+d,"_blank"),!1),localStorage.l="l";break;case"u":updated();break;case"w":""===window.location.hash?(x.fillStyle="black",x.fillRect(0,0,a.width,a.height),x.fillStyle="white",x.font="60px Sans-serif",x.textAlign="center",x.fillText("You won!",a.width/2,200),x.font="30px Sans-serif",x.fillText("The tab containing the video",a.width/2,250),x.fillText("has been found and destroyed",a.width/2,280),x.fillText("by a thousand garbage collectors.",a.width/2,310),x.fillText("Click to play again",a.width/2,600),document.title="You won!",onclick=()=>location=location,stopSound()):close();break;case"m":m=!0,updated();}})}function startSound(){audioContext=new AudioContext;var b=4096;pinkNoise=function(){var c,d,f,h,k,l,n,o;c=d=f=h=k=l=n=0;var q=0,r=100,u=audioContext.createScriptProcessor(b,1,1);return u.onaudioprocess=function(v){var w=v.outputBuffer.getChannelData(0);o=2*Math.random()-1;for(var z=0;z<b;z++)0.9<Math.random()?(0.9<Math.random()&&(r=Math.ceil(5*Math.random())*Math.ceil(5*Math.random())),o=2*Math.random()-1):o=Math.sin(q++/r),c=0.99886*c+0.0555179*o,d=0.99332*d+0.0750759*o,f=0.969*f+0.153852*o,h=0.8665*h+0.3104856*o,k=0.55*k+0.5329522*o,l=-0.7616*l-0.016898*o,w[z]=c+d+f+h+k+l+n+0.5362*o,w[z]*=0.11,n=0.115926*o},u}(),pinkNoise.connect(audioContext.destination)}function stopSound(){pinkNoise.disconnect()}
        </script>